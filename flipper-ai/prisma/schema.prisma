// Flipper.ai Database Schema
// Using SQLite for simple, file-based persistence

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// Marketplace sources we scrape from
enum Platform {
  CRAIGSLIST
  FACEBOOK_MARKETPLACE
  EBAY
  OFFERUP
}

// Status of a listing in our pipeline
enum ListingStatus {
  NEW           // Just scraped
  ANALYZING     // Calculating flip potential
  OPPORTUNITY   // Good flip opportunity identified
  CONTACTED     // Seller has been contacted
  PURCHASED     // Item purchased
  LISTED        // Re-listed for sale
  SOLD          // Successfully flipped
  PASSED        // Decided to skip
  EXPIRED       // Listing no longer available
}

// Raw listings scraped from marketplaces
model Listing {
  id              String        @id @default(cuid())
  externalId      String        // Original listing ID from the platform
  platform        String        // CRAIGSLIST, FACEBOOK_MARKETPLACE, EBAY, OFFERUP
  url             String
  title           String
  description     String?
  askingPrice     Float
  condition       String?
  location        String?
  sellerName      String?
  sellerContact   String?
  imageUrls       String?       // JSON array of image URLs
  category        String?
  postedAt        DateTime?
  scrapedAt       DateTime      @default(now())

  // Flip analysis
  estimatedValue  Float?        // What we think it's worth (midpoint)
  estimatedLow    Float?        // Low end of estimated value range
  estimatedHigh   Float?        // High end of estimated value range
  profitPotential Float?        // Estimated profit if flipped
  profitLow       Float?        // Low end profit estimate
  profitHigh      Float?        // High end profit estimate
  valueScore      Float?        // 0-100 score of flip potential
  discountPercent Float?        // How far below market value (e.g., 40 = 40% below)
  resaleDifficulty String?      // VERY_EASY, EASY, MODERATE, HARD, VERY_HARD
  status          String        @default("NEW")

  // Market references (JSON)
  comparableUrls  String?       // JSON: URLs to eBay sold listings, etc.
  priceReasoning  String?       // Explanation of how value was estimated
  notes           String?       // AI-generated analysis notes

  // Additional metadata for flipping
  shippable       Boolean?      // Can be shipped (vs local pickup only)
  estimatedWeight Float?        // Estimated weight in lbs (for shipping cost)
  negotiable      Boolean?      // Is price negotiable? (detected from OBO, firm, etc.)
  daysListed      Int?          // Days since originally posted
  tags            String?       // JSON: Array of detected keywords for filtering

  // AI-generated purchase request message
  requestToBuy    String?       // AI-generated message to send to seller

  // Relations
  opportunity     Opportunity?

  // Indexes
  @@unique([platform, externalId])
  @@index([platform])
  @@index([status])
  @@index([valueScore])
  @@index([scrapedAt])
}

// Flip opportunities we're actively pursuing
model Opportunity {
  id              String        @id @default(cuid())
  listingId       String        @unique
  listing         Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Purchase info
  purchasePrice   Float?
  purchaseDate    DateTime?
  purchaseNotes   String?

  // Resale info
  resalePrice     Float?
  resalePlatform  String?
  resaleUrl       String?
  resaleDate      DateTime?

  // Profit tracking
  actualProfit    Float?
  fees            Float?        // Platform fees, shipping, etc.

  // Status
  status          String        @default("IDENTIFIED")
  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Scraper job runs
model ScraperJob {
  id              String        @id @default(cuid())
  platform        String
  location        String?
  category        String?
  status          String        @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  listingsFound   Int           @default(0)
  opportunitiesFound Int        @default(0)
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime      @default(now())

  @@index([status])
  @@index([createdAt])
}

// Search configurations for automated scraping
model SearchConfig {
  id              String        @id @default(cuid())
  name            String
  platform        String
  location        String
  category        String?
  keywords        String?       // Comma-separated keywords
  minPrice        Float?
  maxPrice        Float?
  enabled         Boolean       @default(true)
  lastRun         DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([enabled])
}

// Price history for market value estimation
model PriceHistory {
  id              String        @id @default(cuid())
  productName     String
  category        String?
  platform        String
  soldPrice       Float
  condition       String?
  soldAt          DateTime
  createdAt       DateTime      @default(now())

  @@index([productName])
  @@index([category])
}
